# 私有 OpenShift 集群安装指南

本指南介绍如何在本地生成 `install-config.yaml` 配置文件，然后在 bastion host 上安装私有 OpenShift 集群。

## 概述

由于您要安装私有集群（Internal 类型），安装过程需要在 bastion host 上执行，因为私有集群的 API 服务器无法从外部网络访问。

## 步骤 1: 本地生成 install-config.yaml

### 1.1 检查前置条件

确保您已经：
- 运行了 `create-vpc.sh` 创建了 VPC
- 运行了 `create-bastion.sh` 创建了 bastion host
- 安装了必要的工具（yq, openshift-install, aws cli）

### 1.2 生成配置文件

在本地执行以下命令生成 `install-config.yaml`：

```bash
# 使用 dry-run 模式只生成配置文件，不执行安装
AWS_PROFILE=static ./deploy-openshift.sh --dry-run
```

### 1.3 交互式配置

脚本会启动交互式配置过程，您需要提供以下信息：

```
? SSH Public Key /Users/weli/.ssh/id_rsa.pub
? Platform aws
? Region us-east-1
? Base Domain qe.devcluster.openshift.com
? Cluster Name weli-test-cluster
? Pull Secret [粘贴您的 pull secret]
```

**重要提示：**
- **SSH Public Key**: 使用 bastion host 的 SSH 密钥路径
- **Region**: 必须与 VPC 所在区域一致
- **Base Domain**: 确保您有该域名的 DNS 控制权
- **Pull Secret**: 从 Red Hat 获取的 pull secret

### 1.4 验证生成的文件

脚本完成后，您应该看到：

```
✅ install-config.yaml generated by openshift-install!
🔧 Patching install-config.yaml with VPC configuration...
✅ install-config.yaml patched with VPC configuration!
✅ Backup created: install-config.yaml.backup.20250623-181958
```

生成的文件位置：
- `./openshift-install/install-config.yaml` - 主配置文件
- `install-config.yaml.backup.20250623-181958` - 备份文件

## 步骤 2: 连接到 Bastion Host

### 2.1 使用自动化连接脚本

```bash
# 使用提供的连接脚本
./connect-bastion.sh
```

### 2.2 手动连接（如果需要）

```bash
# 设置 SSH 密钥权限
chmod 600 ~/.ssh/your-key-pair.pem

# 连接到 bastion host
ssh -i ~/.ssh/your-key-pair.pem ec2-user@<bastion-public-ip>
```

## 步骤 3: 在 Bastion Host 上准备安装环境

### 3.1 上传 install-config.yaml 到 Bastion Host

从本地机器上传配置文件：

```bash
# 从本地执行，上传配置文件到 bastion host
scp -i ~/.ssh/your-key-pair.pem ./openshift-install/install-config.yaml ec2-user@<bastion-public-ip>:~/install-config.yaml
```

### 3.2 在 Bastion Host 上下载 OpenShift 安装程序

连接到 bastion host 后，下载安装程序：

```bash
# 设置版本变量
OPENSHIFT_VERSION="4.18.15"

# 创建安装目录
mkdir -p ~/openshift-install
cd ~/openshift-install

# 下载 OpenShift 安装程序
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OPENSHIFT_VERSION/openshift-install-linux.tar.gz
tar xzf openshift-install-linux.tar.gz
chmod +x openshift-install
rm openshift-install-linux.tar.gz

# 下载 oc 客户端
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OPENSHIFT_VERSION/openshift-client-linux.tar.gz
tar xzf openshift-client-linux.tar.gz
chmod +x oc kubectl
rm openshift-client-linux.tar.gz

# 验证安装程序
./openshift-install version
```

### 3.3 配置 AWS 凭证

确保 bastion host 有正确的 AWS 凭证：

```bash
# 配置 AWS 凭证
aws configure --profile static

# 或者设置环境变量
export AWS_PROFILE=static
export AWS_DEFAULT_REGION=us-east-1

# 验证凭证
aws sts get-caller-identity
```

## 步骤 4: 执行集群安装

### 4.1 准备安装目录

```bash
# 创建安装目录
mkdir -p ~/cluster-install
cd ~/cluster-install

# 复制配置文件
cp ~/install-config.yaml .

# 验证配置文件
./openshift-install create install-config --dir=. --dry-run
```

### 4.2 开始安装

```bash
# 开始集群安装（详细日志模式）
./openshift-install --log-level=info create cluster --dir=.

# 或者使用后台运行（推荐用于长时间安装）
nohup ./openshift-install --log-level=info create cluster --dir=. > install.log 2>&1 &
```

### 4.3 监控安装进度

```bash
# 查看安装日志
tail -f install.log

# 或者实时查看安装进度
./openshift-install --log-level=info create cluster --dir=. 2>&1 | tee install.log
```

### 4.4 安装完成后的验证

安装完成后，您会看到类似输出：

```
INFO Install complete!
INFO To access the cluster as the system:admin user when using 'oc', run 'export KUBECONFIG=/home/ec2-user/cluster-install/auth/kubeconfig'
INFO Access the OpenShift web-console here: https://console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com
INFO Login to the console with user: "kubeadmin", and password: "xxxxx-xxxxx-xxxxx-xxxxx"
```

## 步骤 5: 访问集群

### 5.1 设置环境变量

```bash
# 设置 kubeconfig
export KUBECONFIG=/home/ec2-user/cluster-install/auth/kubeconfig

# 验证集群访问
oc whoami
oc get nodes
```

### 5.2 访问 Web 控制台

从 bastion host 访问控制台：

```bash
# 使用 curl 测试控制台访问
curl -k https://console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com

# 或者使用 SSH 隧道从本地访问
# 在本地机器上执行：
ssh -i ~/.ssh/your-key-pair.pem -L 8443:console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com:443 ec2-user@<bastion-public-ip>
```

然后在本地浏览器访问：`https://localhost:8443`

## 步骤 6: 下载集群访问文件

### 6.1 从 Bastion Host 下载重要文件

```bash
# 在本地机器上执行，下载集群访问文件
scp -i ~/.ssh/your-key-pair.pem ec2-user@<bastion-public-ip>:~/cluster-install/auth/kubeconfig ~/kubeconfig-weli-test-cluster
scp -i ~/.ssh/your-key-pair.pem ec2-user@<bastion-public-ip>:~/cluster-install/auth/kubeadmin-password ~/kubeadmin-password-weli-test-cluster
```

### 6.2 在本地使用集群

```bash
# 设置 kubeconfig
export KUBECONFIG=~/kubeconfig-weli-test-cluster

# 验证访问
oc whoami
oc get nodes
```

## 故障排除

### 常见问题

1. **安装卡住或失败**
   ```bash
   # 检查 AWS 资源
   aws ec2 describe-instances --filters "Name=tag:kubernetes.io/cluster/weli-test-cluster,Values=owned"
   
   # 查看详细日志
   tail -f install.log
   ```

2. **网络连接问题**
   ```bash
   # 检查 VPC 配置
   aws ec2 describe-vpcs --vpc-ids vpc-04d8f5e06211f6de6
   
   # 检查安全组
   aws ec2 describe-security-groups --filters "Name=vpc-id,Values=vpc-04d8f5e06211f6de6"
   ```

3. **权限问题**
   ```bash
   # 验证 AWS 权限
   aws iam get-user
   aws iam list-attached-user-policies --user-name <your-username>
   ```

### 重新开始安装

如果安装失败需要重新开始：

```bash
# 清理安装目录
rm -rf ~/cluster-install

# 重新创建目录并复制配置文件
mkdir -p ~/cluster-install
cd ~/cluster-install
cp ~/install-config.yaml .

# 重新开始安装
./openshift-install --log-level=info create cluster --dir=.
```

## 清理资源

安装完成后，如果需要删除集群：

```bash
# 在 bastion host 上执行
cd ~/cluster-install
./openshift-install destroy cluster --dir=.
```

## 总结

1. **本地生成配置**: 使用 `deploy-openshift.sh --dry-run` 生成 `install-config.yaml`
2. **上传到 Bastion**: 将配置文件上传到 bastion host
3. **准备环境**: 在 bastion host 上下载安装程序并配置 AWS 凭证
4. **执行安装**: 使用 `openshift-install create cluster` 开始安装
5. **监控进度**: 使用详细日志模式监控安装过程
6. **访问集群**: 通过 kubeconfig 或 Web 控制台访问集群

这个流程确保了私有集群能够正确安装，并且您可以从 bastion host 访问集群的所有功能。 