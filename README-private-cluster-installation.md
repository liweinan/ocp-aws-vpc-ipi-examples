# ç§æœ‰ OpenShift é›†ç¾¤å®‰è£…æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åœ¨æœ¬åœ°ç”Ÿæˆ `install-config.yaml` é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨ bastion host ä¸Šå®‰è£…ç§æœ‰ OpenShift é›†ç¾¤ã€‚

## æ¦‚è¿°

ç”±äºæ‚¨è¦å®‰è£…ç§æœ‰é›†ç¾¤ï¼ˆInternal ç±»å‹ï¼‰ï¼Œå®‰è£…è¿‡ç¨‹éœ€è¦åœ¨ bastion host ä¸Šæ‰§è¡Œï¼Œå› ä¸ºç§æœ‰é›†ç¾¤çš„ API æœåŠ¡å™¨æ— æ³•ä»å¤–éƒ¨ç½‘ç»œè®¿é—®ã€‚

## æ­¥éª¤ 1: æœ¬åœ°ç”Ÿæˆ install-config.yaml

### 1.1 æ£€æŸ¥å‰ç½®æ¡ä»¶

ç¡®ä¿æ‚¨å·²ç»ï¼š
- è¿è¡Œäº† `create-vpc.sh` åˆ›å»ºäº† VPC
- è¿è¡Œäº† `create-bastion.sh` åˆ›å»ºäº† bastion host
- å®‰è£…äº†å¿…è¦çš„å·¥å…·ï¼ˆyq, openshift-install, aws cliï¼‰

### 1.2 ç”Ÿæˆé…ç½®æ–‡ä»¶

åœ¨æœ¬åœ°æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ `install-config.yaml`ï¼š

```bash
# ä½¿ç”¨ dry-run æ¨¡å¼åªç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œä¸æ‰§è¡Œå®‰è£…
AWS_PROFILE=static ./deploy-openshift.sh --dry-run
```

### 1.3 äº¤äº’å¼é…ç½®

è„šæœ¬ä¼šå¯åŠ¨äº¤äº’å¼é…ç½®è¿‡ç¨‹ï¼Œæ‚¨éœ€è¦æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

```
? SSH Public Key /Users/weli/.ssh/id_rsa.pub
? Platform aws
? Region us-east-1
? Base Domain qe.devcluster.openshift.com
? Cluster Name weli-test-cluster
? Pull Secret [ç²˜è´´æ‚¨çš„ pull secret]
```

**é‡è¦æç¤ºï¼š**
- **SSH Public Key**: ä½¿ç”¨ bastion host çš„ SSH å¯†é’¥è·¯å¾„
- **Region**: å¿…é¡»ä¸ VPC æ‰€åœ¨åŒºåŸŸä¸€è‡´
- **Base Domain**: ç¡®ä¿æ‚¨æœ‰è¯¥åŸŸåçš„ DNS æ§åˆ¶æƒ
- **Pull Secret**: ä» Red Hat è·å–çš„ pull secret

### 1.4 éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶

è„šæœ¬å®Œæˆåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```
âœ… install-config.yaml generated by openshift-install!
ğŸ”§ Patching install-config.yaml with VPC configuration...
âœ… install-config.yaml patched with VPC configuration!
âœ… Backup created: install-config.yaml.backup.20250623-181958
```

ç”Ÿæˆçš„æ–‡ä»¶ä½ç½®ï¼š
- `./openshift-install/install-config.yaml` - ä¸»é…ç½®æ–‡ä»¶
- `install-config.yaml.backup.20250623-181958` - å¤‡ä»½æ–‡ä»¶

## æ­¥éª¤ 2: è¿æ¥åˆ° Bastion Host

### 2.1 ä½¿ç”¨è‡ªåŠ¨åŒ–è¿æ¥è„šæœ¬

```bash
# ä½¿ç”¨æä¾›çš„è¿æ¥è„šæœ¬
./connect-bastion.sh
```

### 2.2 æ‰‹åŠ¨è¿æ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
# è®¾ç½® SSH å¯†é’¥æƒé™
chmod 600 ~/.ssh/your-key-pair.pem

# è¿æ¥åˆ° bastion host
ssh -i ~/.ssh/your-key-pair.pem ec2-user@<bastion-public-ip>
```

## æ­¥éª¤ 3: åœ¨ Bastion Host ä¸Šå‡†å¤‡å®‰è£…ç¯å¢ƒ

### 3.1 ä¸Šä¼  install-config.yaml åˆ° Bastion Host

ä»æœ¬åœ°æœºå™¨ä¸Šä¼ é…ç½®æ–‡ä»¶ï¼š

```bash
# ä»æœ¬åœ°æ‰§è¡Œï¼Œä¸Šä¼ é…ç½®æ–‡ä»¶åˆ° bastion host
scp -i ~/.ssh/your-key-pair.pem ./openshift-install/install-config.yaml ec2-user@<bastion-public-ip>:~/install-config.yaml
```

### 3.2 åœ¨ Bastion Host ä¸Šä¸‹è½½ OpenShift å®‰è£…ç¨‹åº

è¿æ¥åˆ° bastion host åï¼Œä¸‹è½½å®‰è£…ç¨‹åºï¼š

```bash
# è®¾ç½®ç‰ˆæœ¬å˜é‡
OPENSHIFT_VERSION="4.18.15"

# åˆ›å»ºå®‰è£…ç›®å½•
mkdir -p ~/openshift-install
cd ~/openshift-install

# ä¸‹è½½ OpenShift å®‰è£…ç¨‹åº
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OPENSHIFT_VERSION/openshift-install-linux.tar.gz
tar xzf openshift-install-linux.tar.gz
chmod +x openshift-install
rm openshift-install-linux.tar.gz

# ä¸‹è½½ oc å®¢æˆ·ç«¯
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OPENSHIFT_VERSION/openshift-client-linux.tar.gz
tar xzf openshift-client-linux.tar.gz
chmod +x oc kubectl
rm openshift-client-linux.tar.gz

# éªŒè¯å®‰è£…ç¨‹åº
./openshift-install version
```

### 3.3 é…ç½® AWS å‡­è¯

ç¡®ä¿ bastion host æœ‰æ­£ç¡®çš„ AWS å‡­è¯ï¼š

```bash
# é…ç½® AWS å‡­è¯
aws configure --profile static

# æˆ–è€…è®¾ç½®ç¯å¢ƒå˜é‡
export AWS_PROFILE=static
export AWS_DEFAULT_REGION=us-east-1

# éªŒè¯å‡­è¯
aws sts get-caller-identity
```

## æ­¥éª¤ 4: æ‰§è¡Œé›†ç¾¤å®‰è£…

### 4.1 å‡†å¤‡å®‰è£…ç›®å½•

```bash
# åˆ›å»ºå®‰è£…ç›®å½•
mkdir -p ~/cluster-install
cd ~/cluster-install

# å¤åˆ¶é…ç½®æ–‡ä»¶
cp ~/install-config.yaml .

# éªŒè¯é…ç½®æ–‡ä»¶
./openshift-install create install-config --dir=. --dry-run
```

### 4.2 å¼€å§‹å®‰è£…

```bash
# å¼€å§‹é›†ç¾¤å®‰è£…ï¼ˆè¯¦ç»†æ—¥å¿—æ¨¡å¼ï¼‰
./openshift-install --log-level=info create cluster --dir=.

# æˆ–è€…ä½¿ç”¨åå°è¿è¡Œï¼ˆæ¨èç”¨äºé•¿æ—¶é—´å®‰è£…ï¼‰
nohup ./openshift-install --log-level=info create cluster --dir=. > install.log 2>&1 &
```

### 4.3 ç›‘æ§å®‰è£…è¿›åº¦

```bash
# æŸ¥çœ‹å®‰è£…æ—¥å¿—
tail -f install.log

# æˆ–è€…å®æ—¶æŸ¥çœ‹å®‰è£…è¿›åº¦
./openshift-install --log-level=info create cluster --dir=. 2>&1 | tee install.log
```

### 4.4 å®‰è£…å®Œæˆåçš„éªŒè¯

å®‰è£…å®Œæˆåï¼Œæ‚¨ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
INFO Install complete!
INFO To access the cluster as the system:admin user when using 'oc', run 'export KUBECONFIG=/home/ec2-user/cluster-install/auth/kubeconfig'
INFO Access the OpenShift web-console here: https://console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com
INFO Login to the console with user: "kubeadmin", and password: "xxxxx-xxxxx-xxxxx-xxxxx"
```

## æ­¥éª¤ 5: è®¿é—®é›†ç¾¤

### 5.1 è®¾ç½®ç¯å¢ƒå˜é‡

```bash
# è®¾ç½® kubeconfig
export KUBECONFIG=/home/ec2-user/cluster-install/auth/kubeconfig

# éªŒè¯é›†ç¾¤è®¿é—®
oc whoami
oc get nodes
```

### 5.2 è®¿é—® Web æ§åˆ¶å°

ä» bastion host è®¿é—®æ§åˆ¶å°ï¼š

```bash
# ä½¿ç”¨ curl æµ‹è¯•æ§åˆ¶å°è®¿é—®
curl -k https://console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com

# æˆ–è€…ä½¿ç”¨ SSH éš§é“ä»æœ¬åœ°è®¿é—®
# åœ¨æœ¬åœ°æœºå™¨ä¸Šæ‰§è¡Œï¼š
ssh -i ~/.ssh/your-key-pair.pem -L 8443:console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com:443 ec2-user@<bastion-public-ip>
```

ç„¶ååœ¨æœ¬åœ°æµè§ˆå™¨è®¿é—®ï¼š`https://localhost:8443`

## æ­¥éª¤ 6: ä¸‹è½½é›†ç¾¤è®¿é—®æ–‡ä»¶

### 6.1 ä» Bastion Host ä¸‹è½½é‡è¦æ–‡ä»¶

```bash
# åœ¨æœ¬åœ°æœºå™¨ä¸Šæ‰§è¡Œï¼Œä¸‹è½½é›†ç¾¤è®¿é—®æ–‡ä»¶
scp -i ~/.ssh/your-key-pair.pem ec2-user@<bastion-public-ip>:~/cluster-install/auth/kubeconfig ~/kubeconfig-weli-test-cluster
scp -i ~/.ssh/your-key-pair.pem ec2-user@<bastion-public-ip>:~/cluster-install/auth/kubeadmin-password ~/kubeadmin-password-weli-test-cluster
```

### 6.2 åœ¨æœ¬åœ°ä½¿ç”¨é›†ç¾¤

```bash
# è®¾ç½® kubeconfig
export KUBECONFIG=~/kubeconfig-weli-test-cluster

# éªŒè¯è®¿é—®
oc whoami
oc get nodes
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å®‰è£…å¡ä½æˆ–å¤±è´¥**
   ```bash
   # æ£€æŸ¥ AWS èµ„æº
   aws ec2 describe-instances --filters "Name=tag:kubernetes.io/cluster/weli-test-cluster,Values=owned"
   
   # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   tail -f install.log
   ```

2. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```bash
   # æ£€æŸ¥ VPC é…ç½®
   aws ec2 describe-vpcs --vpc-ids vpc-04d8f5e06211f6de6
   
   # æ£€æŸ¥å®‰å…¨ç»„
   aws ec2 describe-security-groups --filters "Name=vpc-id,Values=vpc-04d8f5e06211f6de6"
   ```

3. **æƒé™é—®é¢˜**
   ```bash
   # éªŒè¯ AWS æƒé™
   aws iam get-user
   aws iam list-attached-user-policies --user-name <your-username>
   ```

### é‡æ–°å¼€å§‹å®‰è£…

å¦‚æœå®‰è£…å¤±è´¥éœ€è¦é‡æ–°å¼€å§‹ï¼š

```bash
# æ¸…ç†å®‰è£…ç›®å½•
rm -rf ~/cluster-install

# é‡æ–°åˆ›å»ºç›®å½•å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶
mkdir -p ~/cluster-install
cd ~/cluster-install
cp ~/install-config.yaml .

# é‡æ–°å¼€å§‹å®‰è£…
./openshift-install --log-level=info create cluster --dir=.
```

## æ¸…ç†èµ„æº

å®‰è£…å®Œæˆåï¼Œå¦‚æœéœ€è¦åˆ é™¤é›†ç¾¤ï¼š

```bash
# åœ¨ bastion host ä¸Šæ‰§è¡Œ
cd ~/cluster-install
./openshift-install destroy cluster --dir=.
```

## æ€»ç»“

1. **æœ¬åœ°ç”Ÿæˆé…ç½®**: ä½¿ç”¨ `deploy-openshift.sh --dry-run` ç”Ÿæˆ `install-config.yaml`
2. **ä¸Šä¼ åˆ° Bastion**: å°†é…ç½®æ–‡ä»¶ä¸Šä¼ åˆ° bastion host
3. **å‡†å¤‡ç¯å¢ƒ**: åœ¨ bastion host ä¸Šä¸‹è½½å®‰è£…ç¨‹åºå¹¶é…ç½® AWS å‡­è¯
4. **æ‰§è¡Œå®‰è£…**: ä½¿ç”¨ `openshift-install create cluster` å¼€å§‹å®‰è£…
5. **ç›‘æ§è¿›åº¦**: ä½¿ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼ç›‘æ§å®‰è£…è¿‡ç¨‹
6. **è®¿é—®é›†ç¾¤**: é€šè¿‡ kubeconfig æˆ– Web æ§åˆ¶å°è®¿é—®é›†ç¾¤

è¿™ä¸ªæµç¨‹ç¡®ä¿äº†ç§æœ‰é›†ç¾¤èƒ½å¤Ÿæ­£ç¡®å®‰è£…ï¼Œå¹¶ä¸”æ‚¨å¯ä»¥ä» bastion host è®¿é—®é›†ç¾¤çš„æ‰€æœ‰åŠŸèƒ½ã€‚ 