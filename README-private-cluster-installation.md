# 私有 OpenShift 集群安装指南

本指南介绍如何在本地生成 `install-config.yaml` 配置文件，然后在 bastion host 上安装私有 OpenShift 集群。

## 概述

由于您要安装私有集群（Internal 类型），安装过程需要在 bastion host 上执行，因为私有集群的 API 服务器无法从外部网络访问。

**注意：** 在以下命令中，请将 `<bastion-public-ip>` 替换为您实际的 bastion host 公网 IP 地址。您可以通过以下方式获取：
- 查看 `bastion-output/bastion-public-ip` 文件
- 或运行 `./connect-bastion.sh` 脚本查看连接信息

## 步骤 1: 本地生成 install-config.yaml

### 1.1 检查前置条件

确保您已经：
- 运行了 `create-vpc.sh` 创建了 VPC
- 运行了 `create-bastion.sh` 创建了 bastion host
- 安装了必要的工具（yq, openshift-install, aws cli）

### 1.2 生成配置文件

在本地执行以下命令生成 `install-config.yaml`：

```bash
# 使用 dry-run 模式只生成配置文件，不执行安装
AWS_PROFILE=static ./deploy-openshift.sh --dry-run
```

### 1.3 交互式配置

脚本会启动交互式配置过程，您需要提供以下信息：

```
? SSH Public Key /Users/weli/.ssh/id_rsa.pub
? Platform aws
? Region us-east-1
? Base Domain qe.devcluster.openshift.com
? Cluster Name weli-test-cluster
? Pull Secret [粘贴您的 pull secret]
```

**重要提示：**
- **SSH Public Key**: 使用您的个人SSH公钥（用于访问OpenShift集群节点）
- **Region**: 必须与 VPC 所在区域一致
- **Base Domain**: 确保您有该域名的 DNS 控制权
- **Pull Secret**: 从 Red Hat 获取的 pull secret

### 1.4 SSH密钥配置说明

**重要：OpenShift集群和Bastion host使用不同的SSH密钥！**

- **Bastion Host**: 使用 `weli-test-cluster-bastion-key` 密钥对
- **OpenShift集群节点**: 使用您在配置时指定的SSH公钥（通常是您的个人密钥）

这意味着：
- ✅ 您可以用bastion密钥连接到bastion host
- ❌ 但您无法从bastion host连接到OpenShift集群节点（因为节点使用的是您的个人SSH密钥）

**解决方案：将您的SSH私钥复制到Bastion Host**

```bash
# 从本地机器执行，复制您的SSH私钥到bastion host
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.ssh/id_rsa ec2-user@<bastion-public-ip>:~/.ssh/id_rsa

# 复制公钥（可选，用于验证）
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.ssh/id_rsa.pub ec2-user@<bastion-public-ip>:~/.ssh/id_rsa.pub
```

**在bastion host上设置SSH密钥权限：**

```bash
# 连接到bastion host
ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>

# 在bastion host上设置SSH密钥权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub

# 测试连接到集群节点（安装完成后）
ssh core@<cluster-node-private-ip>
```

**验证SSH密钥配置：**

```bash
# 在bastion host上验证可以访问集群节点
export KUBECONFIG=~/openshift-cluster/auth/kubeconfig
oc get nodes
oc debug node/<node-name>
```

### 1.5 验证生成的文件

脚本完成后，您应该看到：

```
✅ install-config.yaml generated by openshift-install!
🔧 Patching install-config.yaml with VPC configuration...
✅ install-config.yaml patched with VPC configuration!
✅ Backup created: install-config.yaml.backup.20250623-181958
```

生成的文件位置：
- `./openshift-install/install-config.yaml` - 主配置文件
- `install-config.yaml.backup.20250623-181958` - 备份文件

## 步骤 2: 连接到 Bastion Host

### 2.1 使用自动化连接脚本

```bash
# 使用提供的连接脚本
./connect-bastion.sh
```

### 2.2 手动连接（如果需要）

```bash
# 设置 SSH 密钥权限
chmod 600 ./bastion-output/weli-test-cluster-bastion-key.pem

# 连接到 bastion host
ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>
```

## 步骤 3: 在 Bastion Host 上准备安装环境

### 3.1 上传 install-config.yaml 到 Bastion Host

从本地机器上传配置文件：

```bash
# 从本地执行，上传配置文件到 bastion host
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ./openshift-install/install-config.yaml ec2-user@<bastion-public-ip>:~/install-config.yaml
```

### 3.2 在 Bastion Host 上下载 OpenShift 安装程序

连接到 bastion host 后，下载安装程序：

```bash
# 设置版本变量
OPENSHIFT_VERSION="4.18.15"

# 创建安装目录
mkdir -p ~/openshift-install
cd ~/openshift-install

# 下载 OpenShift 安装程序
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OPENSHIFT_VERSION/openshift-install-linux.tar.gz
tar xzf openshift-install-linux.tar.gz
chmod +x openshift-install
rm openshift-install-linux.tar.gz

# 下载 oc 客户端
wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/$OPENSHIFT_VERSION/openshift-client-linux.tar.gz
tar xzf openshift-client-linux.tar.gz
chmod +x oc kubectl
rm openshift-client-linux.tar.gz

# 验证安装程序
./openshift-install version
./oc version
```

### 3.3 配置 AWS 凭证

确保 bastion host 有正确的 AWS 凭证。推荐使用以下方法从本地机器上传凭证：

#### 方法 1: 上传 AWS 凭证文件（推荐）

**从本地机器执行：**

```bash
# 上传 AWS 凭证文件到 bastion host
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.aws/credentials ec2-user@<bastion-public-ip>:~/.aws/credentials

# 上传 AWS 配置文件
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.aws/config ec2-user@<bastion-public-ip>:~/.aws/config
```

**在 bastion host 上设置权限：**

```bash
# 连接到 bastion host
ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>

# 在 bastion host 上创建 .aws 目录并设置权限
mkdir -p ~/.aws
chmod 700 ~/.aws
chmod 600 ~/.aws/credentials
chmod 600 ~/.aws/config

# 验证凭证
aws sts get-caller-identity --profile static
```

#### 方法 2: 使用环境变量

**从本地机器执行：**

```bash
# 获取您的 AWS 凭证并上传到 bastion host
aws configure export-credentials --profile static --format env | ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip> "cat > ~/aws-env.sh"
```

**在 bastion host 上使用：**

```bash
# 连接到 bastion host
ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>

# 加载环境变量
source ~/aws-env.sh

# 验证凭证
aws sts get-caller-identity
```

#### 方法 3: 手动配置

**在 bastion host 上执行：**

```bash
# 创建 .aws 目录
mkdir -p ~/.aws

# 配置 AWS 凭证
aws configure --profile static

# 或者设置环境变量
export AWS_PROFILE=static
export AWS_DEFAULT_REGION=us-east-1

# 验证凭证
aws sts get-caller-identity
```

**重要提示：**
- 确保 `.aws` 目录权限为 700
- 确保 `credentials` 和 `config` 文件权限为 600
- 使用 `--profile static` 参数来指定正确的配置文件

### 3.4 配置SSH密钥访问集群节点

**重要：为了能够从bastion host访问OpenShift集群节点，您需要复制您的SSH私钥到bastion host。**

#### 从本地机器复制SSH密钥

```bash
# 复制您的SSH私钥到bastion host
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.ssh/id_rsa ec2-user@<bastion-public-ip>:~/.ssh/id_rsa

# 复制公钥（可选，用于验证）
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.ssh/id_rsa.pub ec2-user@<bastion-public-ip>:~/.ssh/id_rsa.pub
```

#### 在bastion host上设置SSH密钥权限

```bash
# 连接到bastion host
ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>

# 在bastion host上设置SSH密钥权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub

# 验证SSH密钥配置
ls -la ~/.ssh/
```

#### 验证SSH密钥配置

安装完成后，您可以测试SSH连接到集群节点：

```bash
# 获取集群节点信息
export KUBECONFIG=~/openshift-cluster/auth/kubeconfig
oc get nodes -o wide

# 测试SSH连接到集群节点（使用节点内部IP）
ssh core@<cluster-node-private-ip>

# 或者使用oc debug命令访问节点
oc debug node/<node-name>
```

**注意：**
- Bastion host使用 `weli-test-cluster-bastion-key` 密钥对
- OpenShift集群节点使用您的个人SSH密钥
- 复制私钥后，您就可以从bastion host完全访问集群节点了

## 步骤 4: 执行集群安装

### 4.1 准备安装目录

```bash
# 创建专用的集群安装目录
mkdir -p ~/openshift-cluster
cd ~/openshift-cluster

# 复制配置文件
cp ~/install-config.yaml .

# 复制 OpenShift 安装程序到当前目录
cp ~/openshift-install/openshift-install .
cp ~/openshift-install/oc .
cp ~/openshift-install/kubectl .

# 设置执行权限
chmod +x openshift-install oc kubectl

# 验证安装程序
./openshift-install version
./oc version

# 验证配置文件
./openshift-install create install-config --dir=. --dry-run
```

### 4.2 开始安装

```bash
# 开始集群安装（详细日志模式）
./openshift-install --log-level=info create cluster --dir=.

# 或者使用后台运行（推荐用于长时间安装）
nohup ./openshift-install --log-level=info create cluster --dir=. > install.log 2>&1 &
```

### 4.3 监控安装进度

```bash
# 查看安装日志
tail -f install.log

# 或者实时查看安装进度
./openshift-install --log-level=info create cluster --dir=. 2>&1 | tee install.log
```

### 4.4 安装完成后的验证

安装完成后，您会看到类似输出：

```
INFO Install complete!
INFO To access the cluster as the system:admin user when using 'oc', run 'export KUBECONFIG=/home/ec2-user/openshift-cluster/auth/kubeconfig'
INFO Access the OpenShift web-console here: https://console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com
INFO Login to the console with user: "kubeadmin", and password: "xxxxx-xxxxx-xxxxx-xxxxx"
```

## 步骤 5: 访问集群

### 5.1 设置环境变量

```bash
# 设置 kubeconfig
export KUBECONFIG=/home/ec2-user/openshift-cluster/auth/kubeconfig

# 验证集群访问
./oc whoami
./oc get nodes
```

### 5.2 访问 Web 控制台

从 bastion host 访问控制台：

```bash
# 使用 curl 测试控制台访问
curl -k https://console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com

# 或者使用 SSH 隧道从本地访问
# 在本地机器上执行：
ssh -i ./bastion-output/weli-test-cluster-bastion-key.pem -L 8443:console-openshift-console.apps.weli-test-cluster.qe.devcluster.openshift.com:443 ec2-user@<bastion-public-ip>
```

然后在本地浏览器访问：`https://localhost:8443`

## 步骤 6: 下载集群访问文件

### 6.1 从 Bastion Host 下载重要文件

```bash
# 在本地机器上执行，下载集群访问文件
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>:~/openshift-cluster/auth/kubeconfig ~/kubeconfig-weli-test-cluster
scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ec2-user@<bastion-public-ip>:~/openshift-cluster/auth/kubeadmin-password ~/kubeadmin-password-weli-test-cluster
```

### 6.2 在本地使用集群

```bash
# 设置 kubeconfig
export KUBECONFIG=~/kubeconfig-weli-test-cluster

# 验证访问
oc whoami
oc get nodes
```

## 故障排除

### 常见问题

1. **安装卡住或失败**
   ```bash
   # 检查 AWS 资源
   aws ec2 describe-instances --filters "Name=tag:kubernetes.io/cluster/weli-test-cluster,Values=owned"
   
   # 查看详细日志
   tail -f install.log
   ```

2. **网络连接问题**
   ```bash
   # 检查 VPC 配置
   aws ec2 describe-vpcs --vpc-ids vpc-04d8f5e06211f6de6
   
   # 检查安全组
   aws ec2 describe-security-groups --filters "Name=vpc-id,Values=vpc-04d8f5e06211f6de6"
   ```

3. **权限问题**
   ```bash
   # 验证 AWS 权限
   aws iam get-user
   aws iam list-attached-user-policies --user-name <your-username>
   ```

4. **openshift-install 找不到**
   ```bash
   # 确保在正确的目录中
   pwd
   ls -la openshift-install
   
   # 如果文件不存在，重新复制
   cp ~/openshift-install/openshift-install .
   chmod +x openshift-install
   ```

5. **SSH密钥访问问题**
   ```bash
   # 检查SSH密钥权限
   ls -la ~/.ssh/
   
   # 确保私钥权限正确
   chmod 600 ~/.ssh/id_rsa
   chmod 644 ~/.ssh/id_rsa.pub
   
   # 测试SSH连接到集群节点
   ssh -i ~/.ssh/id_rsa core@<cluster-node-ip>
   
   # 如果无法连接，检查节点安全组是否允许SSH
   aws ec2 describe-security-groups --filters "Name=tag:kubernetes.io/cluster/weli-test-cluster,Values=owned"
   ```

6. **无法从bastion host访问集群节点**
   ```bash
   # 检查是否复制了正确的SSH私钥
   ls -la ~/.ssh/id_rsa
   
   # 重新复制SSH私钥（从本地机器执行）
   scp -i ./bastion-output/weli-test-cluster-bastion-key.pem ~/.ssh/id_rsa ec2-user@<bastion-public-ip>:~/.ssh/id_rsa
   
   # 在bastion host上设置权限
   chmod 600 ~/.ssh/id_rsa
   
   # 验证集群节点访问
   export KUBECONFIG=~/openshift-cluster/auth/kubeconfig
   oc get nodes -o wide
   ssh core@<node-internal-ip>
   ```

### 重新开始安装

如果安装失败需要重新开始：

```bash
# 清理安装目录
rm -rf ~/openshift-cluster

# 重新创建目录并复制配置文件
mkdir -p ~/openshift-cluster
cd ~/openshift-cluster
cp ~/install-config.yaml .
cp ~/openshift-install/openshift-install .
cp ~/openshift-install/oc .
cp ~/openshift-install/kubectl .
chmod +x openshift-install oc kubectl

# 重新开始安装
./openshift-install --log-level=info create cluster --dir=.
```

## 清理资源

安装完成后，如果需要删除集群：

```bash
# 在 bastion host 上执行
cd ~/openshift-cluster
./openshift-install destroy cluster --dir=.
```

## 总结

1. **本地生成配置**: 使用 `deploy-openshift.sh --dry-run` 生成 `install-config.yaml`
2. **上传到 Bastion**: 将配置文件上传到 bastion host
3. **准备环境**: 在 bastion host 上下载安装程序并配置 AWS 凭证
4. **配置SSH密钥**: 复制您的SSH私钥到bastion host以访问集群节点
5. **创建安装目录**: 使用 `~/openshift-cluster` 作为专用安装目录
6. **执行安装**: 使用 `openshift-install create cluster` 开始安装
7. **监控进度**: 使用详细日志模式监控安装过程
8. **访问集群**: 通过 kubeconfig 或 Web 控制台访问集群

这个流程确保了私有集群能够正确安装，并且您可以从 bastion host 访问集群的所有功能。

**重要提醒：**
- Bastion host和OpenShift集群使用不同的SSH密钥
- 必须将您的个人SSH私钥复制到bastion host才能访问集群节点
- 确保SSH密钥权限设置正确（私钥600，公钥644）